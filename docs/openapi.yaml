openapi: 3.0.3
info:
  title: Chief of State HTTP API
  description: |
    Chief of State provides HTTP/JSON endpoints for processing commands and retrieving entity state.
    These endpoints mirror the gRPC service and support the same operations.

    **Authentication**: Headers sent in requests are propagated as gRPC metadata to write-side handlers.
  version: 1.0.0
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:9001
    description: Local development (default HTTP port, see COS_HTTP_PORT)

# No authentication at the API layer; use ingress/mesh for auth
security: []

tags:
  - name: Commands
    description: Process commands against entities
  - name: State
    description: Retrieve entity state

paths:
  /v1/commands/{entityId}/process:
    post:
      tags:
        - Commands
      summary: Process a command
      description: |
        Sends a command to be processed for the given entity. Chief of State will either provision
        a new entity (if it does not exist) or retrieve the existing entity, then forward the
        command to the write-side handler. Commands for a given entity are processed serially.
      operationId: processCommand
      parameters:
        - $ref: '#/components/parameters/EntityIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProcessCommandRequest'
      responses:
        '200':
          description: Command processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProcessCommandResponse'
        '400':
          description: Bad request (e.g. invalid or missing command)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error (e.g. handler failure, validation error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      x-code-samples:
        - lang: 'bash'
          source: |
            curl -X POST http://localhost:9001/v1/commands/user-123/process \
              -H "Content-Type: application/json" \
              -d '{"command": {"@type": "type.googleapis.com/example.UpdateEmail", "new_email": "user@example.com"}}'

  /v1/entities/{entityId}/state:
    get:
      tags:
        - State
      summary: Get entity state
      description: |
        Retrieves the current state of the entity with the given ID. Use this like a key/value lookup.
      operationId: getState
      parameters:
        - $ref: '#/components/parameters/EntityIdPath'
      responses:
        '200':
          description: Entity state retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetStateResponse'
        '404':
          description: Entity not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      x-code-samples:
        - lang: 'bash'
          source: |
            curl -X GET http://localhost:9001/v1/entities/user-123/state

components:
  parameters:
    EntityIdPath:
      name: entityId
      in: path
      required: true
      description: Unique identifier for the entity
      schema:
        type: string
        example: user-123

  schemas:
    ProcessCommandRequest:
      type: object
      description: Request body for processing a command
      properties:
        entity_id:
          type: string
          description: Entity ID (optional; path parameter takes precedence if both are provided)
          example: user-123
        command:
          $ref: '#/components/schemas/ProtobufAny'
          description: The command to process (protobuf Any, application-specific)
      required:
        - command

    ProcessCommandResponse:
      type: object
      description: Response after a command has been processed
      properties:
        state:
          $ref: '#/components/schemas/ProtobufAny'
          description: The resulting entity state after the command was applied
        meta:
          $ref: '#/components/schemas/MetaData'

    GetStateResponse:
      type: object
      description: Response containing the current entity state
      properties:
        state:
          $ref: '#/components/schemas/ProtobufAny'
          description: The current entity state
        meta:
          $ref: '#/components/schemas/MetaData'

    ProtobufAny:
      type: object
      description: |
        Protobuf `google.protobuf.Any` represented as JSON. The `@type` field specifies
        the fully qualified message type URL. Additional fields depend on your proto schema.
      properties:
        '@type':
          type: string
          description: Fully qualified type URL, e.g. `type.googleapis.com/your.package.YourMessage`
          example: type.googleapis.com/example.User
      additionalProperties: true

    MetaData:
      type: object
      description: Metadata about the entity state
      properties:
        entity_id:
          type: string
          description: Entity unique identifier
        revision_number:
          type: integer
          format: uint32
          description: Revision number (increases sequentially, useful for optimistic locking)
        revision_date:
          type: string
          format: date-time
          description: ISO 8601 timestamp when the state was last modified
        data:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/ProtobufAny'
          description: Additional metadata
        headers:
          type: array
          items:
            $ref: '#/components/schemas/Header'
          description: Propagated headers

    Header:
      type: object
      properties:
        key:
          type: string
        string_value:
          type: string
        bytes_value:
          type: string
          format: byte
          description: Base64-encoded bytes

    Error:
      type: object
      description: Error response
      properties:
        error:
          type: string
          description: Error message
      required:
        - error
